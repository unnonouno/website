
  
  
 
  
 


<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using Code Generators &mdash; Jubatus</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.0.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Jubatus" href="index.html" />
    <link rel="up" title="Using Framework" href="framework.html" />
    <link rel="next" title="How to Get Clients" href="howtogetclients.html" />
    <link rel="prev" title="Using Framework" href="framework.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">Jubatus</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a href="index.html"
     class="dropdown-toggle"
     data-toggle="dropdown">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
    ><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_distributed.html">Setup in Distributed Mode</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="howtocontribute.html">How to Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="aboutus.html">About Us</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"><ul>
<li><a class="reference internal" href="#">Using Code Generators</a><ul>
<li><a class="reference internal" href="#flow-of-development">Flow of Development</a></li>
<li><a class="reference internal" href="#why-we-use-idl">Why We Use IDL</a></li>
<li><a class="reference internal" href="#composition-of-files">Composition of Files</a></li>
<li><a class="reference internal" href="#jenerator-the-code-generator"><tt class="docutils literal"><span class="pre">jenerator</span></tt>: The Code Generator</a><ul>
<li><a class="reference internal" href="#building-jenerator">Building <tt class="docutils literal"><span class="pre">jenerator</span></tt></a></li>
<li><a class="reference internal" href="#generating-server-proxy-from-idl">Generating Server/Proxy from IDL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-server">Implementing Server</a><ul>
<li><a class="reference internal" href="#mixable-class">Mixable Class</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-proxy">Implementing Proxy</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li><a href="framework.html"
         title="Previous Chapter: Using Framework">&laquo; Using Framework</a></li>
  <li><a href="howtogetclients.html"
         title="Next Chapter: How to Get Clients">How to Get Clien... &raquo;</a></li>
              
            
            
            
            
              <li>
<div id="sourcelink">
  <a href="_sources/server.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="using-code-generators">
<h1>Using Code Generators<a class="headerlink" href="#using-code-generators" title="Permalink to this headline">¶</a></h1>
<p>Development of machine learning algorithms using Jubatus framework starts with writing an IDL (RPC interface definition).
By using a code generator - <tt class="docutils literal"><span class="pre">jenerator</span></tt> (bundled tool with Jubatus)  - you can generate each component (server, proxy, client for each language) from the IDL.
By using this generator, framework users don&#8217;t need to focus on things other than implementing algorithms.</p>
<div class="section" id="flow-of-development">
<h2>Flow of Development<a class="headerlink" href="#flow-of-development" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Define RPC interfaces that the service should have using IDL.</li>
<li>Generate codes for server, proxy, common data structures and clients (C++/Python/Ruby/Java) with <tt class="docutils literal"><span class="pre">jenerator</span></tt> from IDL.</li>
<li>Implement codes of interface of user-defined class and (if necessary) mix operation.</li>
</ol>
<p>Use the <a class="reference external" href="https://github.com/jubatus/jubatus-service-skeleton">skeleton project</a> to get started.</p>
</div>
<div class="section" id="why-we-use-idl">
<h2>Why We Use IDL<a class="headerlink" href="#why-we-use-idl" title="Permalink to this headline">¶</a></h2>
<p>First, there must exist same definitions in six C++ source files every time we add new learning algorithm, that is, header and implementation of client, header and implementation of proxy and header and implementation of server.
This would lead to a &#8220;hotbed&#8221; of bugs every time we had changed the API.</p>
<p>By using IDL, users can create system through the flow above.
Currenly all algorithms (recommener, classifier, regression, stat and graph) defines its interface with <tt class="docutils literal"><span class="pre">jenerator</span></tt>.</p>
</div>
<div class="section" id="composition-of-files">
<h2>Composition of Files<a class="headerlink" href="#composition-of-files" title="Permalink to this headline">¶</a></h2>
<p>Machine learning system that uses Jubatus framework consists of the following files (where <em>NAME</em> is a name of the service).</p>
<ul class="simple">
<li>NAME_serv.cpp: Implementation of the server (edit template generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>)</li>
<li>NAME_serv.hpp: Header file for <tt class="docutils literal"><span class="pre">NAME_serv.cpp</span></tt> (edit template generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>)</li>
<li>NAME_impl.cpp: <tt class="docutils literal"><span class="pre">main</span></tt> function, RPC interface definition for the server and register RPC methods (automatically generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>)</li>
<li>NAME_proxy.cpp: Implementation of the proxy (automatically generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>)</li>
<li>NAME_client.hpp: Implementation of the client to be used in server-to-server communication (automatically generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>)</li>
<li>NAME_types.hpp: Structures and type information (automatically generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>)</li>
</ul>
</div>
<div class="section" id="jenerator-the-code-generator">
<h2><tt class="docutils literal"><span class="pre">jenerator</span></tt>: The Code Generator<a class="headerlink" href="#jenerator-the-code-generator" title="Permalink to this headline">¶</a></h2>
<p>The RPC interface is defined with <a class="reference external" href="https://github.com/msgpack/msgpack-haskell/blob/master/msgpack-idl/Specification.md">MessagePack-IDL</a>.
Aside from MessagePack-IDL&#8217;s original syntax, we must add annotations for each method of RPC service in order to generate Jubatus servers and proxies.</p>
<p>Annotations are interpreted by our code generator, called <tt class="docutils literal"><span class="pre">jenerator</span></tt>, but they are ignored as comments by MessagePack-IDL.
Therefore, we can generate each client with same interface by MessagePack-IDL.</p>
<p>Syntax of annotations for each methods is as follows.</p>
<ul class="simple">
<li>Each method must have 3 annotations, each of them starts with <tt class="docutils literal"><span class="pre">#&#64;</span></tt>, that specifies &#8220;routing&#8221;, &#8220;lock type&#8221; and &#8220;aggregation method&#8221; in order.</li>
<li>The &#8220;routing&#8221; annotation defines how Jubatus Proxy proxy requests.
Three methods (<tt class="docutils literal"><span class="pre">cht</span></tt>, <tt class="docutils literal"><span class="pre">broadcast</span></tt> or <tt class="docutils literal"><span class="pre">random</span></tt>) are available so that we can cover distribution methods used in typical machine learning tasks.<ul>
<li><tt class="docutils literal"><span class="pre">cht</span></tt> means that the request is distributed by using Consistent Hashing.
Methods annotated with <tt class="docutils literal"><span class="pre">cht</span></tt> must take 2 arguments at least.
The first argument is a string that represents a cluster name, and the second is a string that is used as a key for consistent hashing.
Replication level of updated data is 2 by default.
You can change the replication level by specifying like <tt class="docutils literal"><span class="pre">#&#64;cht(1)</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">broadcast</span></tt> means that the request will be broadcasted to all servers in the cluster.</li>
<li><tt class="docutils literal"><span class="pre">random</span></tt> means that the request will be proxied to one randomly-chosen server in the cluster.</li>
</ul>
</li>
<li>The &#8220;lock type&#8221; annotation defines read/write of request, and value must be one of <tt class="docutils literal"><span class="pre">analysis</span></tt>, <tt class="docutils literal"><span class="pre">update</span></tt> or <tt class="docutils literal"><span class="pre">nolock</span></tt>.<ul>
<li>When using <tt class="docutils literal"><span class="pre">analysis</span></tt>, data is locked in server with read lock and is accessible by multiple thread simultaneously.</li>
<li>When using <tt class="docutils literal"><span class="pre">update</span></tt>, data is locked with write lock, so that we can safely update the data.</li>
<li>When using <tt class="docutils literal"><span class="pre">nolock</span></tt>, no locks are aquired in the server.</li>
</ul>
</li>
<li>The &#8220;aggregation&#8221; annotation defines how to aggrate the results of API call from multiple servers.
Available aggregators are written in <a class="reference external" href="https://github.com/jubatus/jubatus/blob/master/jubatus/server/framework/aggregators.hpp">aggregators.hpp</a>.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">void</span></tt> type cannot be used as the return type of methods.
If the return value is not needed, you must add meaningless type such as <tt class="docutils literal"><span class="pre">int</span></tt> or <tt class="docutils literal"><span class="pre">bool</span></tt>.</p>
<p>Here is a example of MessagePack-IDL with annotation.</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">message</span> <span class="n">entry</span> <span class="p">{</span>
  <span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span>
  <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">value</span>
  <span class="mi">2</span><span class="o">:</span> <span class="kt">int</span> <span class="n">version</span>
<span class="p">}</span>

<span class="n">service</span> <span class="n">kvs</span> <span class="p">{</span>
  <span class="cp">#@cht(2) #@update #@pass</span>
  <span class="kt">int</span> <span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span> <span class="n">string</span> <span class="n">value</span><span class="p">)</span>

  <span class="cp">#@cht(2) #@analysis #@pass</span>
  <span class="n">entry</span> <span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">)</span>

  <span class="cp">#@cht(2) #@update #@pass</span>
  <span class="kt">int</span> <span class="n">del</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>

  <span class="cp">#@broadcast #@update #@pass</span>
  <span class="kt">int</span> <span class="n">clear</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="building-jenerator">
<h3>Building <tt class="docutils literal"><span class="pre">jenerator</span></tt><a class="headerlink" href="#building-jenerator" title="Permalink to this headline">¶</a></h3>
<p>You need OCaml (with findlib), extlib and OMake to build <tt class="docutils literal"><span class="pre">jenerator</span></tt>.</p>
<div class="highlight-python"><pre>$ cd jubatus/tools/jenerator
$ omake
$ sudo omake install</pre>
</div>
<p><tt class="docutils literal"><span class="pre">omake</span> <span class="pre">install</span></tt> installs <tt class="docutils literal"><span class="pre">jenerator</span></tt> as <tt class="docutils literal"><span class="pre">/usr/local/bin/jenerator</span></tt> (path may vary depending on your environment). You can also use built <tt class="docutils literal"><span class="pre">jenerator</span></tt> binary directly without installation.</p>
<p>Hint: If you&#8217;re using Ubuntu systems, OCaml (<tt class="docutils literal"><span class="pre">ocaml-native-compilers</span></tt>), findlib (<tt class="docutils literal"><span class="pre">ocaml-findlib</span></tt>), extlib (<tt class="docutils literal"><span class="pre">libextlib-ocaml</span></tt>) and OMake (<tt class="docutils literal"><span class="pre">omake</span></tt>) are available as a binary package.</p>
</div>
<div class="section" id="generating-server-proxy-from-idl">
<h3>Generating Server/Proxy from IDL<a class="headerlink" href="#generating-server-proxy-from-idl" title="Permalink to this headline">¶</a></h3>
<p>Suppose the name of the example above is a file <tt class="docutils literal"><span class="pre">kvs.idl</span></tt>, we can generate codes in the following manner.</p>
<div class="highlight-python"><pre>$ jenerator -l server -o . -n jubatus -t kvs.idl</pre>
</div>
<p>See <a class="reference internal" href="commands.html#jenerator"><em>jenerator</em></a> for the detailed usage of <tt class="docutils literal"><span class="pre">jenerator</span></tt>.</p>
</div>
</div>
<div class="section" id="implementing-server">
<h2>Implementing Server<a class="headerlink" href="#implementing-server" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">kvs_impl.cpp</span></tt> constructs a server instance by using class <tt class="docutils literal"><span class="pre">kvs_serv</span></tt>.
You need to define the class in <tt class="docutils literal"><span class="pre">kvs_serv.hpp</span></tt> and <tt class="docutils literal"><span class="pre">kvs_serv.cpp</span></tt>.
You can use templates (<tt class="docutils literal"><span class="pre">kvs_serv.tmpl.{cpp,hpp}</span></tt>) generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">main</span></tt> function is implemented in <tt class="docutils literal"><span class="pre">kvs_impl.cpp</span></tt>, so users don&#8217;t have to implement it.
Command line options are the same among all servers using Jubatus framework.
The options can be referenced with <tt class="docutils literal"><span class="pre">--help</span></tt> option.</p>
<div class="section" id="mixable-class">
<h3>Mixable Class<a class="headerlink" href="#mixable-class" title="Permalink to this headline">¶</a></h3>
<p>TBD.</p>
</div>
</div>
<div class="section" id="implementing-proxy">
<h2>Implementing Proxy<a class="headerlink" href="#implementing-proxy" title="Permalink to this headline">¶</a></h2>
<p>You have nothing to implement; just compile <tt class="docutils literal"><span class="pre">kvs_proxy.cpp</span></tt>, generated by <tt class="docutils literal"><span class="pre">jenerator</span></tt>, and you will get proxy.</p>
<p><tt class="docutils literal"><span class="pre">kvs_proxy.cpp</span></tt> only has <tt class="docutils literal"><span class="pre">main</span></tt> function, that registers functor for each RPC method that proxies requests and aggregates responses.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2011,2013 PFI &amp; NTT.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>