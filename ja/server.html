
  
  
 
  
 


<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>コード生成器の利用 &mdash; Jubatus</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.0.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Jubatus" href="index.html" />
    <link rel="up" title="フレームワークの利用" href="framework.html" />
    <link rel="next" title="クライアントの入手方法" href="howtogetclients.html" />
    <link rel="prev" title="フレームワークの利用" href="framework.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">Jubatus</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a href="index.html"
     class="dropdown-toggle"
     data-toggle="dropdown">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
    ><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">クイックスタート</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview/summary.html">Jubatus Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">チュートリアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_distributed.html">分散モードでのセットアップ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="documentation.html">ドキュメント</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="howtocontribute.html">プロジェクトに貢献する</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.html">その他の情報</a></li>
<li class="toctree-l1"><a class="reference internal" href="aboutus.html">プロジェクトについて</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"><ul>
<li><a class="reference internal" href="#">コード生成器の利用</a><ul>
<li><a class="reference internal" href="#id2">開発の流れ</a></li>
<li><a class="reference internal" href="#idl">IDL を使用する理由</a></li>
<li><a class="reference internal" href="#id4">ファイルの構成</a></li>
<li><a class="reference internal" href="#jenerator"><tt class="docutils literal"><span class="pre">jenerator</span></tt>: コード生成器</a><ul>
<li><a class="reference internal" href="#id5"><tt class="docutils literal"><span class="pre">jenerator</span></tt> のビルド</a></li>
<li><a class="reference internal" href="#proxy-idl">サーバ/Proxy を IDL から生成する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">サーバの実装</a><ul>
<li><a class="reference internal" href="#mixable">Mixable クラス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#proxy">Proxy の実装</a></li>
<li><a class="reference internal" href="#id7">今後の課題</a><ul>
<li><a class="reference internal" href="#id8">インターフェースと処理記述</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li><a href="framework.html"
         title="Previous Chapter: フレームワークの利用">&laquo; フレームワークの利用</a></li>
  <li><a href="howtogetclients.html"
         title="Next Chapter: クライアントの入手方法">クライアントの入手方法 &raquo;</a></li>
              
            
            
            
            
              <li>
<div id="sourcelink">
  <a href="_sources/server.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="id1">
<h1>コード生成器の利用<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>Jubatus フレームワークを利用した機械学習アルゴリズムの開発では、まず IDL と呼ばれる RPC インタフェース定義ファイルを作成する。
Jubatus に付属するコード生成器 <tt class="docutils literal"><span class="pre">jenerator</span></tt> を使用することで、IDL から各部品 (サーバ, Proxy, 各言語版のクライアント) を生成することができる。
これらの生成器を利用することで、フレームワークの利用者は機械学習アルゴリズムの実装に集中することができる。</p>
<div class="section" id="id2">
<h2>開発の流れ<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ol class="arabic simple">
<li>サービスが持つべきRPCインターフェースを IDL で定義する。</li>
<li><tt class="docutils literal"><span class="pre">jenerator</span></tt> を用いて、IDL から サーバー、Proxy のコード、共通のデータ構造、各言語（C++/Python/Ruby/Java）のクライアントを生成する。</li>
<li>RPC毎にサーバーが利用するユーザ定義クラスのインターフェースの実体、および必要に応じてmix操作を作成する。</li>
</ol>
<p><a class="reference external" href="https://github.com/jubatus/jubatus-service-skeleton">スケルトンプロジェクト</a> を利用すると、容易に開発を開始できる。</p>
</div>
<div class="section" id="idl">
<h2>IDL を使用する理由<a class="headerlink" href="#idl" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Jubatusは機械学習などのアルゴリズムをモジュール化し、容易に追加できることを目的にしているが、公開されている実装に対してrecommenderを追加しようとした場合、それぞれのRPCインターフェースをクライアントのヘッダと実装、Proxyのヘッダと実装、サーバー本体のヘッダと実装の6箇所に定義する必要があった。さらにpficommonのMPRPC_GEN, MPRPC_PROC等、サーバーへの関数登録などで合計7箇所に記述を繰り返す必要があることが明らかになった。
このような設計では、新しい学習アルゴリズムを追加する度に同じRPC定義を7回繰り替えさなければならず、APIの仕様を変更するたびに同じような修正を繰り返さなくてはならないためバグが入り込む温床となっており、機械学習を分散環境で実装するためのフレームワークとして容易に追加できると言いがたい。さらに、C++のマクロおよびテンプレートを多用しているため、コンパイルエラーが複雑なものとなり、Jubatusを用いて機械学習を実装するにはJubatusの深い知識が必要となっていた。</p>
<p>IDL を利用することで、上記のフローで一連のシステムを作成することができることを確認した。
実際に RPC 定義をするのは、7箇所から3箇所に削減された。これを用いて、recommender, classifier, regression, stat, graph が構成出来ることを確認した。</p>
</div>
<div class="section" id="id4">
<h2>ファイルの構成<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Jubatus フレームワークを利用した機械学習システムは、以下のファイルで構成される (<em>NAME</em> はサービスの名称である)。</p>
<ul class="simple">
<li>NAME_serv.cpp: 機能を実装するソースファイル (<tt class="docutils literal"><span class="pre">jenerator</span></tt> で生成されるテンプレートを編集)</li>
<li>NAME_serv.hpp: <tt class="docutils literal"><span class="pre">NAME_serv.cpp</span></tt> に対応するヘッダファイル (<tt class="docutils literal"><span class="pre">jenerator</span></tt> で生成されるテンプレートを編集)</li>
<li>NAME_impl.cpp: サーバの main 関数と RPC インタフェースの定義、RPC メソッドの登録 (<tt class="docutils literal"><span class="pre">jenerator</span></tt> で自動生成)</li>
<li>NAME_proxy.cpp: Proxy の実装 (<tt class="docutils literal"><span class="pre">jenerator</span></tt> で自動生成)</li>
<li>NAME_client.hpp: サーバー間通信で利用するクライアントの実装 (<tt class="docutils literal"><span class="pre">jenerator</span></tt> で自動生成)</li>
<li>NAME_types.hpp: RPC で使用する構造体や型の情報 (<tt class="docutils literal"><span class="pre">jenerator</span></tt> で自動生成)</li>
</ul>
</div>
<div class="section" id="jenerator">
<h2><tt class="docutils literal"><span class="pre">jenerator</span></tt>: コード生成器<a class="headerlink" href="#jenerator" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>RPC インターフェースは <a class="reference external" href="https://github.com/msgpack/msgpack-haskell/blob/master/msgpack-idl/Specification.md">MessagePack-IDL</a> により定義する。
ただし、そのままJubatusのコードを生成するためには、MessagePack-IDL の文法とは別に、RPCサービスの各メソッドにアノテーションをつける必要がある。</p>
<p>アノテーションは Jubatus のコードジェネレータである <tt class="docutils literal"><span class="pre">jenerator</span></tt> では解釈されるが、MessagePack-IDL ではコメントとして無視される。
このため、同じ IDL ファイルで各種クライアントも生成できる。</p>
<p>各メソッドに付与するアノテーションの文法は以下の通りである。</p>
<ul class="simple">
<li>各メソッドには <tt class="docutils literal"><span class="pre">#&#64;</span></tt> で始まる 3 つのアノテーションを付与する必要があり、順番に &#8220;ルーティング&#8221;, &#8220;ロック種類&#8221;, &#8220;結合方法&#8221; を指定する。</li>
<li>&#8220;ルーティング&#8221; には、Proxy がどのようにリクエストをプロキシするかを定義する。
<tt class="docutils literal"><span class="pre">cht</span></tt>, <tt class="docutils literal"><span class="pre">broadcast</span></tt>, <tt class="docutils literal"><span class="pre">random</span></tt> の 3 種類が用意されており、これによって、典型的だと思われる機械学習の分散方式をカバーすることができる。<ul>
<li><tt class="docutils literal"><span class="pre">cht</span></tt> は Consistent Hashing によるリクエストの分散を意味する。
<tt class="docutils literal"><span class="pre">cht</span></tt> アノテーションがあるメソッドは、2 つ以上の引数を取る必要がある。
第 1 引数はクラスタ名を表す string 、第 2 引数が cht のキーとなる string である。
更新データのレプリケーション多重度 (冗長度) はデフォルトでは 2 である。
<tt class="docutils literal"><span class="pre">#&#64;cht(1)</span></tt> のように、更新データのレプリケーション多重度を指定することもできる。</li>
<li><tt class="docutils literal"><span class="pre">broadcast</span></tt> は全サーバーへリクエストをブロードキャストを意味する。</li>
<li><tt class="docutils literal"><span class="pre">random</span></tt> はランダムに選択されたいずれか 1 台のサーバーへリクエストを送信することを表す。</li>
</ul>
</li>
<li>&#8220;ロック種類&#8221; には、リクエストのread/writeを <tt class="docutils literal"><span class="pre">analysis</span></tt>, <tt class="docutils literal"><span class="pre">update</span></tt>, <tt class="docutils literal"><span class="pre">nolock</span></tt> のいずれかで定義する。<ul>
<li><tt class="docutils literal"><span class="pre">analysis</span></tt> では、サーバ側で read ロックされることになり、複数のスレッドからの同時アクセスが可能となる。</li>
<li><tt class="docutils literal"><span class="pre">update</span></tt> では、サーバー側で write ロックされることになり、安全にデータを更新することができる。</li>
<li><tt class="docutils literal"><span class="pre">nolock</span></tt> ではロックは行われない。</li>
</ul>
</li>
<li>&#8220;結合方法&#8221; には、API 呼び出しに対する複数のサーバからの結果を結合する方法を定義する。
利用可能なアグリゲータは <a class="reference external" href="https://github.com/jubatus/jubatus/blob/master/jubatus/server/framework/aggregators.hpp">aggregators.hpp</a> に掲載されている。</li>
</ul>
<p>なお、メソッドの戻り値型に <tt class="docutils literal"><span class="pre">void</span></tt> は利用できない。
返り値が必要ない場合は、意味のない <tt class="docutils literal"><span class="pre">int</span></tt> や <tt class="docutils literal"><span class="pre">bool</span></tt> 型などを指定する必要がある。</p>
<p>以下は、アノテーション付きの IDL の例である。</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">message</span> <span class="n">entry</span> <span class="p">{</span>
  <span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span>
  <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">value</span>
  <span class="mi">2</span><span class="o">:</span> <span class="kt">int</span> <span class="n">version</span>
<span class="p">}</span>

<span class="n">service</span> <span class="n">kvs</span> <span class="p">{</span>
  <span class="cp">#@cht(2) #@update #@pass</span>
  <span class="kt">int</span> <span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span> <span class="n">string</span> <span class="n">value</span><span class="p">)</span>

  <span class="cp">#@cht(2) #@analysis #@pass</span>
  <span class="n">entry</span> <span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">)</span>

  <span class="cp">#@cht(2) #@update #@pass</span>
  <span class="kt">int</span> <span class="n">del</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="o">:</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>

  <span class="cp">#@broadcast #@update #@pass</span>
  <span class="kt">int</span> <span class="n">clear</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">name</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id5">
<h3><tt class="docutils literal"><span class="pre">jenerator</span></tt> のビルド<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">jenerator</span></tt> のビルドには OCaml (findlib あり) 、extlib および OMake が必要である。</p>
<div class="highlight-python"><pre>$ cd jubatus/tools/jenerator
$ omake
$ sudo omake install</pre>
</div>
<p><tt class="docutils literal"><span class="pre">omake</span> <span class="pre">install</span></tt> を行うと <tt class="docutils literal"><span class="pre">jenerator</span></tt> が <tt class="docutils literal"><span class="pre">/usr/local/bin/jenerator</span></tt> としてインストールされる (環境によりパスは異なる場合がある)。インストールを行わずに、ビルドされた <tt class="docutils literal"><span class="pre">jenerator</span></tt> のバイナリを直接使用してもよい。</p>
<p>ヒント: Ubuntu を使用している場合、OCaml (<tt class="docutils literal"><span class="pre">ocaml-native-compilers</span></tt>), findlib (<tt class="docutils literal"><span class="pre">ocaml-findlib</span></tt>), iextlib (<tt class="docutils literal"><span class="pre">libextlib-ocaml</span></tt>), OMake (<tt class="docutils literal"><span class="pre">omake</span></tt>) のバイナリパッケージが利用できる。</p>
</div>
<div class="section" id="proxy-idl">
<h3>サーバ/Proxy を IDL から生成する<a class="headerlink" href="#proxy-idl" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>上に示した例が <tt class="docutils literal"><span class="pre">kvs.idl</span></tt> というファイルに書かれていると仮定して、以下の手順でコードを生成する。</p>
<div class="highlight-python"><pre>$ jenerator -l server -o . -n jubatus -t kvs.idl</pre>
</div>
<p><tt class="docutils literal"><span class="pre">jenerator</span></tt> の詳細な使い方については <a class="reference internal" href="commands.html#jenerator"><em>jenerator</em></a> を参照すること。</p>
</div>
</div>
<div class="section" id="id6">
<h2>サーバの実装<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">kvs_impl.cpp</span></tt> は、 <tt class="docutils literal"><span class="pre">kvs_serv</span></tt> クラスを利用してサーバーを構成する。
このクラスを <tt class="docutils literal"><span class="pre">kvs_serv.{cpp,hpp}</span></tt> に定義する必要がある。
生成されたテンプレート (<tt class="docutils literal"><span class="pre">kvs_serv.tmpl.{cpp,hpp}</span></tt>) をリネームして利用することができる。</p>
<p><tt class="docutils literal"><span class="pre">kvs_impl.cpp</span></tt> の中では <tt class="docutils literal"><span class="pre">main</span></tt> 関数も実装されており、ユーザは <tt class="docutils literal"><span class="pre">main</span></tt> を実装する必要はない。
コマンドライン引数の仕様は Jubatus フレームワークを使用しているサーバの間ですべて共通である。
オプションは <tt class="docutils literal"><span class="pre">--help</span></tt> で参照することができる。</p>
<div class="section" id="mixable">
<h3>Mixable クラス<a class="headerlink" href="#mixable" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>TBD.</p>
</div>
</div>
<div class="section" id="proxy">
<h2>Proxy の実装<a class="headerlink" href="#proxy" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Proxy に関しては、実装をする必要はない。 <tt class="docutils literal"><span class="pre">jenerator</span></tt> が生成した <tt class="docutils literal"><span class="pre">kvs_proxy.cpp</span></tt> をコンパイルすると Proxy が得られる。</p>
<p><tt class="docutils literal"><span class="pre">kvs_proxy.cpp</span></tt> には <tt class="docutils literal"><span class="pre">main</span></tt> 関数の実装だけがあり、各 RPC メソッドごとにリクエストをプロキシし、レスポンスを集約するためのファンクタを登録する。</p>
</div>
<div class="section" id="id7">
<h2>今後の課題<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id8">
<h3>インターフェースと処理記述<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>複数の機械学習を結合したり、特徴量変換と学習器本体を分離するためには、C++を単純に記述していくインターフェースではどこをどうしてよいかが開発者にとって自明でない。現状のジェネレータでは学習器のインターフェースしか記述することができない。アルゴリズム自体も抽象化された言語上で試行錯誤し、機械学習を実装するユーザが一台のマシン上でも、複数台のマシン上でも透過的に実行や試行錯誤ができるような機能を、検討する必要がある。</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2011,2013 PFI &amp; NTT.<br/>
      このドキュメントは <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b3 で生成しました。<br/>
    </p>
  </div>
</footer>
  </body>
</html>